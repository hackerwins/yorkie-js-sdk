<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Drawing Sample</title>
</head>
<body>
  <div>
    <h1>Drawing Sample</h1>
    <canvas width="500px" height="500px" id="draw-panel" style='border: 1px solid black;'></canvas>
    <div>document:</div>
    <pre style="white-space: pre-wrap;"><code id="log-holder"></code></pre>
    <div>text:</div>
    <pre style="white-space: pre-wrap;"><code id="text-log-holder"></code></pre>
  </div>
  <script src="./yorkie.js"></script>
  <script>
    const drawPanel = document.getElementById('draw-panel');


    function drawCanvas (points) {
      const context = drawPanel.getContext('2d');
      context.clearRect(0, 0, 500, 500);

      if (points.length) {
        context.beginPath();
        let isMoved = false; 

        for (const p of points) { 
          if (isMoved === false) {
            isMoved = true; 
            context.moveTo(p.get('x').value, p.get('y').value)          
          } else {
            context.lineTo(p.get('x').value, p.get('y').value)          
          }

        }

        context.stroke();
      }
    }

    const colors = ['#FECEEA', '#FEF1D2', '#A9FDD8', '#D7F8FF', '#CEC5FA'];
    let nextColorIdx = 0;

    const placeholder = document.getElementById('placeholder');
    const logHolder = document.getElementById('log-holder');
    const textLogHolder = document.getElementById('text-log-holder');
    const selectionMap = new Map();

    function displayLog(doc) {
      logHolder.innerText = doc.toJSON();
      textLogHolder.innerText = doc.getRootObject().get('points').toJSON();
    }

    function getPos (e) {

      return {x: e.clientX - drawPanel.offsetLeft, y: e.clientY - drawPanel.offsetTop };
    }

    async function main() {
      try {
        // 01. create client with RPCAddr(envoy) then activate it.
        const client = yorkie.createClient('/api');
        await client.activate();

        // 02. create a document then attach it into the client.
        const doc = yorkie.createDocument('examples', 'draw-panel');
        await client.attach(doc);

        doc.update((root) => {
          root['points'] = [];
        }, 'create content');

        doc.subscribe((event) => {
          drawCanvas(doc.getRootObject().get('points'));
          // displayLog(doc);
        });
        await client.sync();


        document.addEventListener('mousedown', (e) => {

            if (!window.isMouseDown) {
              window.isMouseDown = true; 

              doc.update((root) => {
                root['points'] = [getPos(e)] 
              }, `update content by ${client.getID()}`);
            }
        })   
        
        document.addEventListener('mousemove', (e) => {
          if (window.isMouseDown) {
              const point = getPos(e)

              doc.update((root) => {
                root['points'].push(point) // 배열에 배열을 넣을 수가 없군..... 

                // 가지고온 array 를 매번 문자열로 보냈다가 파싱하다 보니 늦다.  방법이 없을까?                 
                drawCanvas(root['points']) 
              }, `update content by ${client.getID()}`);
          }
        })

        document.addEventListener('mouseup', (e) => {
          if (window.isMouseDown) {
            window.isMouseDown = false;   
          }
        })        

        // 05. set initial value.
        displayLog(doc);
      } catch (e) {
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>
