<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Drawing Example</title>
</head>
<body>
  <div>
    <canvas width="500px" height="500px" id="draw-panel" style='border: 1px solid black;'></canvas>
    <div>document:</div>
    <pre style="white-space: pre-wrap;"><code id="log-holder"></code></pre>
  </div>
  <script src="./yorkie.js"></script>
  <script>
    const drawPanel = document.getElementById('draw-panel');
    const placeholder = document.getElementById('placeholder');
    const logHolder = document.getElementById('log-holder');

    function drawCanvas(points) {
      // TODO Now repainting the whole thing. Only changed parts should be drawn.
      const context = drawPanel.getContext('2d');
      context.clearRect(0, 0, 500, 500);

      if (points.length) {
        context.beginPath();
        let isMoved = false; 

        for (const p of points) {
          if (isMoved === false) {
            isMoved = true; 
            context.moveTo(p.x, p.y);
          } else {
            context.lineTo(p.x, p.y);
          }
        }

        context.stroke();
      }
    }

    function displayLog(doc) {
      return;
      logHolder.innerText = doc.toJSON();
    }

    function getPoint(e) {
      return {
        x: e.clientX - drawPanel.offsetLeft,
        y: e.clientY - drawPanel.offsetTop
      };
    }

    async function main() {
      try {
        // 01. create client with RPCAddr(envoy) then activate it.
        const client = yorkie.createClient('/api');
        await client.activate();

        // 02. create a document then attach it into the client.
        const doc = yorkie.createDocument('examples', 'draw-panel-2');
        await client.attach(doc);

        doc.update((root) => {
          if (!root['points']) {
            root['points'] = [];
          }
        }, 'create points if not exists');

        doc.subscribe((event) => {
          drawCanvas(doc.getRootObject().points);
          displayLog(doc);
        });
        await client.sync();

        document.addEventListener('mousedown', (e) => {
          if (!window.isMouseDown) {
            window.isMouseDown = true; 

            doc.update((root) => {
              root['points'].push(getPoint(e));
            }, `update content by ${client.getID()}`);
          }
        });

        document.addEventListener('mousemove', (e) => {
          if (window.isMouseDown) {
            doc.update((root) => {
              root['points'].push(getPoint(e));
              drawCanvas(root['points']);
            }, `update content by ${client.getID()}`);
          }
        });

        document.addEventListener('mouseup', (e) => {
          if (window.isMouseDown) {
            window.isMouseDown = false;   
          }
        });

        // 05. set initial value.
        drawCanvas(doc.getRootObject().points);
        displayLog(doc);
      } catch (e) {
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>
